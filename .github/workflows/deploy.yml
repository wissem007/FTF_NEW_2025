name: CI/CD Pipeline - Football Management

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # ========================================
      # √âTAPE 1: Checkout du code
      # ========================================
      - name: üì• Checkout code
        uses: actions/checkout@v4

      # ========================================
      # √âTAPE 2: Setup Java 17 pour le backend
      # ========================================
      - name: ‚òï Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'

      # ========================================
      # √âTAPE 3: Build du backend Spring Boot
      # ========================================
      - name: üî® Build Backend (Maven)
        working-directory: ./backend
        run: |
          echo "üöÄ Building Spring Boot application..."
          mvn clean package -DskipTests
          echo "‚úÖ Backend JAR created: $(ls -lh target/*.jar)"

      # ========================================
      # √âTAPE 4: Setup Node.js pour le frontend
      # ========================================
      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: './frontend/package-lock.json'

      # ========================================
      # √âTAPE 5: Build du frontend React
      # ========================================
      - name: üî® Build Frontend (React + Vite)
        working-directory: ./frontend
        run: |
          echo "üöÄ Installing dependencies..."
          npm ci
          echo "üöÄ Building React application..."
          npm run build
          echo "‚úÖ Frontend build created: $(ls -lh dist/)"

      # ========================================
      # √âTAPE 6: Pr√©paration des artifacts
      # ========================================
      - name: üì¶ Prepare deployment artifacts
        run: |
          mkdir -p deploy
          cp backend/target/*.jar deploy/football-management.jar
          cp -r frontend/dist deploy/frontend
          cp deploy-scripts/* deploy/ || echo "‚ö†Ô∏è  No deploy-scripts found"
          ls -lah deploy/

      # ========================================
      # √âTAPE 7: D√©ploiement sur le serveur Debian
      # ========================================
      - name: üöÄ Deploy to Debian Server
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_PORT: ${{ secrets.SERVER_PORT }}
        run: |
          # Configurer SSH
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -p ${SERVER_PORT:-22} $SERVER_HOST >> ~/.ssh/known_hosts

          # Cr√©er les r√©pertoires sur le serveur
          ssh -i ~/.ssh/deploy_key -p ${SERVER_PORT:-22} $SERVER_USER@$SERVER_HOST << 'EOF'
            mkdir -p ~/football-management/backend
            mkdir -p ~/football-management/frontend
            mkdir -p ~/football-management/logs
          EOF

          # Copier le JAR du backend
          echo "üì§ Uploading backend JAR..."
          scp -i ~/.ssh/deploy_key -P ${SERVER_PORT:-22} \
            deploy/football-management.jar \
            $SERVER_USER@$SERVER_HOST:~/football-management/backend/

          # Copier les fichiers du frontend
          echo "üì§ Uploading frontend files..."
          scp -i ~/.ssh/deploy_key -P ${SERVER_PORT:-22} -r \
            deploy/frontend/* \
            $SERVER_USER@$SERVER_HOST:~/football-management/frontend/

          # Red√©marrer le backend
          echo "üîÑ Restarting backend service..."
          ssh -i ~/.ssh/deploy_key -p ${SERVER_PORT:-22} $SERVER_USER@$SERVER_HOST << 'EOF'
            sudo systemctl restart football-management || echo "‚ö†Ô∏è  Service not found, manual setup required"
            sudo systemctl status football-management || true
          EOF

          # Recharger Nginx
          echo "üîÑ Reloading Nginx..."
          ssh -i ~/.ssh/deploy_key -p ${SERVER_PORT:-22} $SERVER_USER@$SERVER_HOST << 'EOF'
            sudo nginx -t && sudo systemctl reload nginx || echo "‚ö†Ô∏è  Nginx not configured"
          EOF

          echo "‚úÖ Deployment completed successfully!"

      # ========================================
      # √âTAPE 8: Notification de succ√®s
      # ========================================
      - name: ‚úÖ Deployment Summary
        if: success()
        run: |
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üéâ D√âPLOIEMENT R√âUSSI"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üì¶ Backend JAR: football-management.jar"
          echo "üåê Frontend: Build React/Vite"
          echo "üñ•Ô∏è  Serveur: ${{ secrets.SERVER_HOST }}"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
